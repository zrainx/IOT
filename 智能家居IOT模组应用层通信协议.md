

# 智能家居IOT模组应用层通信协议

| 版本 | 修改记录 |
| - | - |
| 0.5 | 初稿 |
| 0.6 | 增加设备数据类型 |
| 0.7 | 增加维测命令到公共参数中 |
| 0.8 | 修改参数格式增加业务参数 |

## 简介

本文档主要描述智能家居IOT模组**应用层**通信协议。

协议分为三层：应用层、数据链路层、物理层。如下表：

| 协议分层   | 功能说明                                                     |
| ---------- | ------------------------------------------------------------ |
| 应用层     | 智能家居业务指令或数据                                       |
| 数据链路层 | 负责数据链的建立和拆除、信息传输、传输差错控制、异常情况处理 |
| 物理层     | 信道数据传输                                                 |

本协议工作在应用层，负责处理智能家居业务指令或数据，与数据链路层之间进行交互与数据接口。



## 网络拓扑图

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuKh9J2zABCXGS5Uevb80Wfp4olpI4jlapABaV0MmI71gKLbgaQwTGeXVVaggONHAPf5jKdv9HYmMMIEyiiPuPKtmofhYbJN3AskEIpOOgu_0WhfsOAqMI9Ar2bmEgNafm5030000)

| 名称     | 功能       |
| -------- | ---------- |
| Server   | 服务器节点 |
| TNode    | 终端节点   |
| 中继节点 | 中继节点   |



## 协议规格约束

数据链路层、物理层对应用层的约束如下：

1. 应用层有效载荷最大包长255字节
2. ACK/NACK重传机制由数据链路层保证，应用层不涉及

## 应用层通信帧

应用层通信帧格式如下表：

| 前导码 | 业务载荷长度 | 业务载荷                   | CRC校验 |
| ------ | ------------ | -------------------------- | ------- |
| 0xA5A5 | LEN[1]       | PAYLOAD[0~250]             | CRC[2]  |
| 前导码 | 1字节        | 变长 0 到（255-1-2-2）字节 | 2字节   |

说明：

1. 业务载荷长度是指业务载荷的实际长度，不包括，不包括CRC校验的长度。
2. CRC校验的范围包括：业务载荷长度，业务载荷。
3. 应用层通信帧数据采用大端序传输。

## 业务载荷

业务载荷格式如下表：

| 目的设备寻址模式 / 目的设备地址长度 | 源设备ID | 目的设备ID/描述 | 数据             |
| ----------------------------------- | -------- | --------------- | ---------------- |
| MODE bit7 ，  LEN ：MODE bit 6-0    | SRC[4]   | DST[LEN]        | DATA[245-LEN]    |
| 1字节                               | 4字节    | 变长 0-128字节  | 变长 250-1-4-LEN |

说明：

1. 当MODE 比特位7 为0时，表示目的设备以ID寻址；当MODE 比特位7 为1时，表示目的设备以设备描述寻址，用于广播。
2. LEN 占用MODE的第6到0bit，表示目的设备的地址长度。范围为0-128字节
3. 设备ID 是IOT设备的唯一标识，要求设备在用一个接入网中必须保证唯一。
4. 目的设备描述 用于广播寻址



## 数据

数据由功能字、功能类型、参数长度和参数组成

| 功能字 | 功能类型 | 参数长度 | 参数   |
| ----- | ------- | ----- | ------- |
| FUNC | CLASS | NUM  | Arg[NUM] |
| 1字节   | 1字节   |  1字节 | 变长 NUM 字节 |

### 功能字

| 类型名   | 类型 |
| -------- | ---- |
| 查询 GET | 0x1  |
| 设置 SET | 0x2  |
| 上报 RPT | 0x3  |
| 应答ACK  | 0x4  |

### 功能类型 

功能类型包括

| 功能类型 | 类型 | 功能         | 参数长度（byte） |
| -------- | ---- | ------------ | ---------------- |
| FAC      | 0x1  | 厂家名       | 1～32            |
| DSP      | 0x2  | 自定义描述   | 1～32            |
| SWV      | 0x3  | 软版本号     | 1                |
| TYPE     | 0x4  | 设备类型     | 1                |
| PING     | 0x5  | 心跳         | 1                |
| RFPWR    | 0x6  | 发射功率     | 1                |
| RSRP     | 0x7  | 接收信号强度 | 1                |
| SNR      | 0x8  | 信噪比       | 1                |
| CHANNEL  | 0x9  | 信道选择     | 1                |

功能类型分两类：业务功能类型和维测功能类型，上表中 类型0x1到0x4 为业务功能类型，0x5到0x9为维测功能类型。

### 参数长度

参数长度表示参数的字节数

### 设备类型

不同的功能字搭配不同的设备类型，参数各不相同，详见参数

包括：

| 设备类型                               | 设备类型 |
| -------------------------------------- | -------- |
| 灯控器/调光面版                        | 0x01     |
| 人体移动感应器                         | 0x02     |
| 光照度传感器                           | 0x03     |
| 门磁（窗磁）传感器                     | 0x04     |
| 温湿度传感器                           | 0x05     |
| 环境盒子（空气盒子或者环境检测）传感器 | 0x06     |
| 一键开关（报警）                       | 0x07     |
| 水浸传感器                             | 0x08     |
| 声光报警器                             | 0x09     |
| 烟雾报警器                             | 0x0A     |
| 燃气泄漏传感器                         | 0x0B     |
| 开关面板                               | 0x0C     |
| 情景面板                               | 0x0D     |
| 温控、新风、地暖面板                   | 0x0E     |
| 调光面板、窗帘面板                     | 0x0F     |
| 普通智能插座                           | 0x10     |
| 智能计量插座                           | 0x11     |
| 窗帘电机                               | 0x12     |
| 机械臂、推窗器                         | 0x13     |
| 红外转发器                             | 0x14     |
| 智能门锁                               | 0x15     |
| 透传设备                               | 0x16     |
| ...                                    |          |
| 色温控制器                             | 0x20     |
| RGB灯带控制器                          | 0x21     |
| 单色调光控制器                         | 0x22     |
| 1-10V 控制器                           | 0x23     |
| RGBW控制器                             | 0x24     |
| 开关灯控器                             | 0x25     |
| 可控硅调光器                           | 0x26     |
| RGBCW控制器                            | 0x27     |

## 参数

参数根据不同的功能类型而不同，因为功能类型分为业务和维测两类，参数也分为业务和维测两类

### 业务参数

不同设备类型的业务参数不同。

功能类型 FAC DSP SWV 后跟的参数为字符串；

| 功能字 | 功能类型      | 参数长度 | 参数          |
| ------ | ------------- | -------- | ------------- |
| FUNC   | FAC /DSP/ SWV | NUM      | STRING        |
| 1字节  | 1字节         | X字节    | 变长 NUM 字节 |

功能类型DEVICE 后跟1字节的设备类型码，再跟设备类型参数

| 功能字 | 功能类型 | 参数长度 | 参数       | 参数            |
| ------ | -------- | -------- | ---------- | --------------- |
| FUNC   | DEVICE   | NUM      | 设备类型码 | 设备类型参数    |
| 1字节  | 1字节    | X字节    | 1字节      | 变长 NUM-1 字节 |

其中 NUM 长度包括 设备类型码 和 设备类型参数

#### 色温控制器

包括了LED驱动，功能是调节灯具的色温（亮度），譬如4500K,6500K；

通信模块控制：接口连PWM1、PWM2、VCC、GND， 通过控制PWM1,PWM2两通道，可实现调节亮度、色温、开关功能。

| 功能类型 | 枚举 | 含义       | 长度 |
| -------- | ---- | ---------- | ---- |
| FAC      | 0x1  | 厂家名     | MINQ |
| DSP      | 0x2  | 自定义描述 | SW   |
| SWV      | 0x3  | 软版本号   |      |
| TYPE     | 0x4  | 设备类型   | 0x20 |

| 设备类型参数 | 铲毒毒 | 含义  |
| ------------ | ------ | ----- |
| PWM1         | 1字节  | 0-255 |
| PWM2         | 1字节  | 0-255 |

#### RGB灯带控制器

不带LED驱动，功能是控制灯带的颜色（亮度）；

通信模块控制：接口连PWM1、PWM2、PWM3、VCC、GND, 通过控制PWM1，PWM2,PWM3（对应RGB）三通道，可实现调节亮度、颜色、开关功能。

| 功能类型 | 枚举 | 含义       | 取值    |
| -------- | ---- | ---------- | ------- |
| FAC      | 0x1  | 厂家名     | MINQ    |
| DSP      | 0x2  | 自定义描述 | DSTGKZQ |
| SWV      | 0x3  | 软版本号   |         |
| DEVICE   | 0x4  | 设备类型   | 0x21    |

| 设备类型参数 | 长度  | 范围  |
| ------------ | ----- | ----- |
| PWM1         | 1字节 | 0-255 |
| PWM2         | 1字节 | 0-255 |
| PWM3         | 1字节 | 0-255 |

####  单色调光控制器

单色调光控制器：带了LED驱动，功能是控制亮度；

通信模块控制：接口连PWM1、VCC、GND, 通过控制PWM1，实现调节亮度、开关功能。

| 功能类型 | 枚举 | 含义       | 取值 |
| -------- | ---- | ---------- | ---- |
| FAC      | 0x1  | 厂家名     | MINQ |
| DSP      | 0x2  | 自定义描述 | DSTG |
| SWV      | 0x3  | 软版本号   |      |
| DEVICE   | 0x4  | 设备类型   | 0x22 |

| 设备类型参数 | 长度  | 范围  |
| ------------ | ----- | ----- |
| PWM1         | 1字节 | 0-255 |

#### 1V10V控制器

不带LED驱动，功能是控制亮度；

通信模块控制：接口连PWM1、VCC、GND、IO, 通过控制PWM1来调光、IO来通断继电器（AC交流输出控制），实现调节亮度、开关功能。

| 功能类型 | 枚举 | 含义       | 取值  |
| -------- | ---- | ---------- | ----- |
| FAC      | 0x1  | 厂家名     | MINQ  |
| DSP      | 0x2  | 自定义描述 | 1V10V |
| SWV      | 0x3  | 软版本号   |       |
| DEVICE   | 0x4  | 设备类型   | 0x23  |

| 设备类型参数 | 长度  | 范围                        |
| ------------ | ----- | --------------------------- |
| PWM1         | 1字节 | 0-255                       |
| IO           | 1字节 | 8bit，每bit 1表示开 0表示关 |

#### RGBW控制器

带了驱动，功能是控制颜色（亮度）；

通信模块控制：接口连PWM1、PWM2、PWM3、PWM4、VCC、GND, 通过控制PWM1、PWM2、PWM3、PWM4（对应RGBW）四通道，可实现调节颜色、亮度、开关功能。

| 功能类型 | 类型 | 含义       | 取值    |
| -------- | ---- | ---------- | ------- |
| FAC      | 0x1  | 厂家名     | MINQ    |
| DSP      | 0x2  | 自定义描述 | 1-10KZQ |
| SWV      | 0x3  | 软版本号   |         |
| DEVICE   | 0x4  | 设备类型   | 0x24    |

| 设备类型参数 | 长度  | 范围  |
| ------------ | ----- | ----- |
| PWM1         | 1字节 | 0-255 |
| PWM2         | 1字节 | 0-255 |
| PWM3         | 1字节 | 0-255 |
| PWM4         | 1字节 | 0-255 |

#### 开关灯控器

不带LED驱动，信号控制，类似插座方式，功能是控制开关；

通信模块控制: 接口连VCC、GND、PWM或者I/O（看软件实现），实现开关功能。

| 功能类型 | 枚举 | 含义       | 取值    |
| -------- | ---- | ---------- | ------- |
| FAC      | 0x1  | 厂家名     | MINQ    |
| DSP      | 0x2  | 自定义描述 | 1-10KZQ |
| SWV      | 0x3  | 软版本号   |         |
| DEVICE   | 0x4  | 设备类型   | 0x25    |

| 设备类型参数 | 长度  | 范围                        |
| ------------ | ----- | --------------------------- |
| PWM1         | 1字节 | 8bit，每bit 1表示开 0表示关 |

####  可控硅调光器

不带LED驱动，需要加可控硅调光器，功能是控制亮度；

通信模块控制：接口连PWM1、VCC、GND, 通过控制PWM1，实现调节亮度、开关功能。

| 设备类型功能类型 | 枚举 | 含义       | 取值 |
| ---------------- | ---- | ---------- | ---- |
| FAC              | 0x1  | 厂家名     | MINQ |
| DSP              | 0x2  | 自定义描述 | KKG  |
| SWV              | 0x3  | 软版本号   |      |
| DEVICE           | 0x4  | 设备类型   | 0x26 |

| 设备类型参数 | 长度  | 范围   |
| ------------ | ----- | ------ |
| PWM1         | 1字节 | 0～255 |

#### RGBCW控制器

带LED驱动。功能是可以调节色温、颜色、亮度和开关。

通信模块控制: 接口连PWM1、PWM2、PWM3、PWM4、IO、VCC、GND, 通过控制PWM1、PWM2、PWM3、（对应RGB）三通道调节颜色，PWM4和IO控制色温，可实现调节色温、颜色、亮度、开关功能。相当于既有RGB灯也有色温灯两个功能。

| 功能类型 | 枚举 | 含义       | 取值  |
| -------- | ---- | ---------- | ----- |
| FAC      | 0x1  | 厂家名     | MINQ  |
| DSP      | 0x2  | 自定义描述 | RGBCW |
| SWV      | 0x3  | 软版本号   |       |
| DEVICE   | 0x4  | 设备类型   | 0x27  |

| 参数 | 长度  | 范围                        |
| ---- | ----- | --------------------------- |
| PWM1 | 1字节 | 0～255                      |
| PWM2 | 1字节 | 0～255                      |
| PWM3 | 1字节 | 0～255                      |
| PWM4 | 1字节 | 0～255                      |
| IO   | 1字节 | 8bit，每bit 1表示开 0表示关 |

### 维测参数

#### PING  0x5  心跳  

#### RFPWR  0x6  发射功率  

#### RSRP  0x7  接收信号强度 

#### SNR  0x8  信噪比  

####  CHANNEL  0x9  信道选择 

## 交互

设置并查询 FAC 和 SWV

1. 0x02 0xFF 0x02 0x01 0x0D ASCII('FatoryName') 0x03 0x04 ASCII('2019')
2. 0x04
3. 0x01 0xFF 0x02 0x01 0x03
4. 0x03 0xFF 0x02 0x01 0x0D ASCII('FatoryName') 0x03 0x04 ASCII('2019')

含义如下图：

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuGfEBIfBBLBGjLFmoqz9LR1I27ODKJ2eS7DJC59mStHMC3HKK79BJ2x9BwhqIynDLL883WzJC55GCZ8mj5JY0ki1weMQOgNWwEoDQQGxgf504p0r1WMGOAr3QbuAqF40)  

设置并查询 TYPE

1. 0x02 0xFF 0x01 0x04 0x01 0x10
2. 0x04
3. 0x01 0xFF 0x01 0x04
4. 0x03 0xFF 0x01 0x04 0x01 0x10

含义如下图：

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuGfEBIfBBLBGjLFmoqz9LR1I27ODKJ2eS7DJC5G8YGnm1L865OO6N61Pe2geUYi5HsTlJCtkg9enTGK5O3NT8JKl1UWQ0000)

其他设备类型

 (TODO)参考[产品列表](https://github.com/zrainx/IOT/blob/master/%E4%BA%A7%E5%93%81%E5%88%97%E8%A1%A8.docx)



