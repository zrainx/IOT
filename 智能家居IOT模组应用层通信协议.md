# 智能家居IOT模组应用层通信协议



## 简介

本文档主要描述智能家居IOT模组**应用层**通信协议。

协议分为三层：应用层、数据链路层、物理层。如下表：

| 协议分层   | 功能说明                                                     |
| ---------- | ------------------------------------------------------------ |
| 应用层     | 智能家居业务指令或数据                                       |
| 数据链路层 | 负责数据链的建立和拆除、信息传输、传输差错控制、异常情况处理 |
| 物理层     | 信道数据传输                                                 |

本协议工作在应用层，负责处理智能家居业务指令或数据，与数据链路层之间进行交互与数据接口。

## 协议规格约束

数据链路层、物理层对应用层的约束如下：

1. 应用层有效载荷最大包长255字节
2. ACK/NACK重传机制又数据链路层保证，应用层不涉及

## 应用层通信帧格式

应用层通信帧格式如下表：

| 业务载荷长度 | 业务载荷                 | CRC校验 |
| ------------ | ------------------------ | ------- |
| LEN[1]       | PAYLOAD[0~252]           | CRC[2]  |
| 1字节        | 变长 0 到（255-1-2）字节 | 2字节   |

说明：

1. 业务载荷长度是指业务载荷的实际长度，不包括CRC校验的长度。
2. CRC校验的范围包括：业务载荷长度，业务载荷。
3. 应用层通信帧数据采用大端序传输。

## 业务载荷格式

业务载荷格式如下表：

| 源设备ID | 目的设备ID | 设备类型码  | 命令类型码  | 参数数组                     |
| -------- | ---------- | ----------- | ----------- | ---------------------------- |
| SRC[4]   | DST[4]     | DEV_TYPE[2] | CMD_TYPE[2] | ARG[0~241]                   |
| 4字节    | 4字节      | 2字节       | 1字节       | 变长 0 到（252-4-4-2-1）字节 |

说明：

1. 设备ID 是IOT设备的唯一标识，要求设备在用一个接入网中必须保证唯一。
2. 设备ID中 0x00000000 和 0xFFFFFFFF为保留字。
3. 0xFFFFFFFF表示任意ID，用于广播场景。
4. 命令类型码分成两类，下发型命令类和上报型命令类。下发型命令类主动设置、查询设备；而上报型命令在接收到下发型命令后进行被动回应。
5. 业务载荷中是下发型命令时，设备类型码表示的是目的设备的类型；业务载荷中是上报型命令时，设备类型码表示的是源设备的类型。

##  设备类型码

1.  网关                                  0x0080

2. 无线开关                            0x0081

3. 窗帘控制器                        0x0082

4. 无线插座                            0x0083

5. 红外报警器                        0x0085

6. 无线转红外                        0x0086

7. 指纹锁                               0x0087

8. 门磁                                   0x0088

9. 声控                                   0x0089

10. 烟感                                   0x008A

11. 气感                                   0x008B

12. 风雨感应器                        0x008C

13. 温湿度PM2.5传感器          0x008D

14. 玻璃破碎探测器                 0x008E

15. 紧急按钮                            0x008F

16. 机械臂                               0x0090

17. 警铃                                   0x0091

18. 遥控器                                0x0093

19. 调光开关                            0x0094

20. 高温                                   0x0095

21. 情景面板                            0x0096

22. 音乐面板                            0x0097

23. 调光单控开关                     0x0098

24. 调光彩灯开关                     0x0099

    （TO DO）

## 控制码

1. 开                                      0x65
2. 关                                      0x00
3.  加                                     0x66
4.  减                                     0x67
5. 暂停                                  0x68
6. 握手                                  0x69
7. 上报                                  0x71
8. 探索                                  0x72
9. 查询                                  0x73
10. 状态反转                          0x74
11. 设备地址设置                   0x76
12. 参数设置                          0x79

   （TO DO）

## 举例

   （TO DO）