# 智能家居IOT模组应用层通信协议



## 简介

本文档主要描述智能家居IOT模组**应用层**通信协议。

协议分为三层：应用层、数据链路层、物理层。如下表：

| 协议分层   | 功能说明                                                     |
| ---------- | ------------------------------------------------------------ |
| 应用层     | 智能家居业务指令或数据                                       |
| 数据链路层 | 负责数据链的建立和拆除、信息传输、传输差错控制、异常情况处理 |
| 物理层     | 信道数据传输                                                 |

本协议工作在应用层，负责处理智能家居业务指令或数据，与数据链路层之间进行交互与数据接口。



## 网络拓扑图

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuKh9J2zABCXGS5Uevb80Wfp4olpI4jlapABaV0MmI71gKLbgaQwTGeXVVaggONHAPf5jKdv9HYmMMIEyiiPuPKtmofhYbJN3AskEIpOOgu_0WhfsOAqMI9Ar2bmEgNafm5030000)

| 名称     | 功能       |
| -------- | ---------- |
| Server   | 服务器节点 |
| TNode    | 终端节点   |
| 中继节点 | 中继节点   |



## 协议规格约束

数据链路层、物理层对应用层的约束如下：

1. 应用层有效载荷最大包长255字节
2. ACK/NACK重传机制由数据链路层保证，应用层不涉及

## 应用层通信帧格式

应用层通信帧格式如下表：

| 前导码 | 业务载荷长度 | 业务载荷                   | CRC校验 |
| ------ | ------------ | -------------------------- | ------- |
| 0xA5A5 | LEN[1]       | PAYLOAD[0~250]             | CRC[2]  |
| 前导码 | 1字节        | 变长 0 到（255-1-2-2）字节 | 2字节   |

说明：

1. 业务载荷长度是指业务载荷的实际长度，不包括，不包括CRC校验的长度。
2. CRC校验的范围包括：业务载荷长度，业务载荷。
3. 应用层通信帧数据采用大端序传输。

## 业务载荷格式

业务载荷格式如下表：

| 目的设备寻址模式 / 目的设备地址长度 | 源设备ID | 目的设备ID/描述 | 数据             |
| ----------------------------------- | -------- | --------------- | ---------------- |
| MODE bit7 ，  LEN ：MODE bit 6-0    | SRC[4]   | DST[LEN]        | DATA[245-LEN]    |
| 1字节                               | 4字节    | 变长 0-128字节  | 变长 250-1-4-LEN |

说明：

1. 当MODE 比特位7 为0时，表示目的设备以ID寻址；当MODE 比特位7 为1时，表示目的设备以设备描述寻址，用于广播。
2. LEN 占用MODE的第6到0bit，表示目的设备的地址长度。范围为0-128字节
3. 设备ID 是IOT设备的唯一标识，要求设备在用一个接入网中必须保证唯一。
4. 目的设备描述 用于广播寻址



## 数据格式

| 消息字 | 参数个数 | 参数数组                         |
| ------ | -------- | -------------------------------- |
| MSG    | NUM      | ARG[0~243]                       |
| 1字节  | 1字节    | 变长 0 到（250-1-4-LEN-1-1）字节 |

### 消息字

| 类型名   | 类型  | 值   |
| -------- | ----- | ---- |
| 查询 GET | 1字节 | 0x1  |
| 设置 SET | 1字节 | 0x2  |
| 上报 RPT | 1字节 | 0x3  |
| ACK      | 1字节 | 0x4  |

### 参数数组

| 参数类型 TYPE | 参数   |
| ------------- | ------ |
| 1字节         | 0～242 |

#### 参数类型

 TYPE（设备类型）包括：

| 参数类型                               | 类型 |
| -------------------------------------- | ---- |
| 灯控器/调光面版                        | 0x01 |
| 人体移动感应器                         | 0x02 |
| 光照度传感器                           | 0x03 |
| 门磁（窗磁）传感器                     | 0x04 |
| 温湿度传感器                           | 0x05 |
| 环境盒子（空气盒子或者环境检测）传感器 | 0x06 |
| 一键开关（报警）                       | 0x07 |
| 水浸传感器                             | 0x08 |
| 声光报警器                             | 0x09 |
| 烟雾报警器                             | 0x0A |
| 燃气泄漏传感器                         | 0x0B |
| 开关面板                               | 0x0C |
| 情景面板                               | 0x0D |
| 温控、新风、地暖面板                   | 0x0E |
| 调光面板、窗帘面板                     | 0x0F |
| 普通智能插座                           | 0x10 |
| 智能计量插座                           | 0x11 |
| 窗帘电机                               | 0x12 |
| 机械臂、推窗器                         | 0x13 |
| 红外转发器                             | 0x14 |
| 智能门锁                               | 0x15 |
| 透传设备                               | 0x16 |
| ...                                    | 0xFE |
| 公共                                   | 0xFF |

说明：

所有设备均有公共参数，公共参数包括：设备厂家名，自定义描述，软版本号，设备类型。

##### 查询 GET

| 参数 | 类型 | 功能       |
| ---- | ---- | ---------- |
| FAC  | 0x1  | 厂家名     |
| DSP  | 0x2  | 自定义描述 |
| SWV  | 0x3  | 软版本号   |
| TYPE | 0x4  | 设备类型   |

##### 设置SET

| 参数 | 值   | 长度  | 功能   |
| ---- | ---- | ----- | ------ |
| FAC  | 0x1  | 1～32 | string |
| DSP  | 0x2  | 1～32 | string |
| SWV  | 0x3  | 1～32 | string |
| TYPE | 0x4  | 1     | byte   |

##### 上报 RPT

| 参数 | 值   | 长度  | 值     |
| ---- | ---- | ----- | ------ |
| FAC  | 0x1  | 1～32 | string |
| DSP  | 0x2  | 1～32 | string |
| SWV  | 0x3  | 1～32 | string |
| TYPE | 0x4  | 1     | byte   |

## 举例

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuGfEBIfBBLBGjLFmoqz9LR1I27ODKJ1IS7DqLZ0qL51oIqmkoI-gz4lCJLLI20uFKp1HK38oCBHKuW8h1sg36c2buEZiZMcQEzmqe6PCFK41n5dca9gN0dGj0000)  



其他TYPE 详见  产品列表 



（TODO 维测 消息）




