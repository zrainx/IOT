# 智能家居IOT模组应用层通信协议

| 版本 | 修改记录 |
| - | - |
| 0.5 | 初稿 |
| 0.6 | 增加设备数据类型 |
| 0.7 | 增加维测命令到公共参数中 |

## 简介

本文档主要描述智能家居IOT模组**应用层**通信协议。

协议分为三层：应用层、数据链路层、物理层。如下表：

| 协议分层   | 功能说明                                                     |
| ---------- | ------------------------------------------------------------ |
| 应用层     | 智能家居业务指令或数据                                       |
| 数据链路层 | 负责数据链的建立和拆除、信息传输、传输差错控制、异常情况处理 |
| 物理层     | 信道数据传输                                                 |

本协议工作在应用层，负责处理智能家居业务指令或数据，与数据链路层之间进行交互与数据接口。



## 网络拓扑图

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuKh9J2zABCXGS5Uevb80Wfp4olpI4jlapABaV0MmI71gKLbgaQwTGeXVVaggONHAPf5jKdv9HYmMMIEyiiPuPKtmofhYbJN3AskEIpOOgu_0WhfsOAqMI9Ar2bmEgNafm5030000)

| 名称     | 功能       |
| -------- | ---------- |
| Server   | 服务器节点 |
| TNode    | 终端节点   |
| 中继节点 | 中继节点   |



## 协议规格约束

数据链路层、物理层对应用层的约束如下：

1. 应用层有效载荷最大包长255字节
2. ACK/NACK重传机制由数据链路层保证，应用层不涉及

## 应用层通信帧格式

应用层通信帧格式如下表：

| 前导码 | 业务载荷长度 | 业务载荷                   | CRC校验 |
| ------ | ------------ | -------------------------- | ------- |
| 0xA5A5 | LEN[1]       | PAYLOAD[0~250]             | CRC[2]  |
| 前导码 | 1字节        | 变长 0 到（255-1-2-2）字节 | 2字节   |

说明：

1. 业务载荷长度是指业务载荷的实际长度，不包括，不包括CRC校验的长度。
2. CRC校验的范围包括：业务载荷长度，业务载荷。
3. 应用层通信帧数据采用大端序传输。

## 业务载荷格式

业务载荷格式如下表：

| 目的设备寻址模式 / 目的设备地址长度 | 源设备ID | 目的设备ID/描述 | 数据             |
| ----------------------------------- | -------- | --------------- | ---------------- |
| MODE bit7 ，  LEN ：MODE bit 6-0    | SRC[4]   | DST[LEN]        | DATA[245-LEN]    |
| 1字节                               | 4字节    | 变长 0-128字节  | 变长 250-1-4-LEN |

说明：

1. 当MODE 比特位7 为0时，表示目的设备以ID寻址；当MODE 比特位7 为1时，表示目的设备以设备描述寻址，用于广播。
2. LEN 占用MODE的第6到0bit，表示目的设备的地址长度。范围为0-128字节
3. 设备ID 是IOT设备的唯一标识，要求设备在用一个接入网中必须保证唯一。
4. 目的设备描述 用于广播寻址



## 数据格式

| 消息字 | 参数类型 | 参数个数 | 参数   |
| ----- | ------- | ----- | ------- |
| MSG    | TYPE     | NUM  | for (i==0;i<NUM;i++) {ArgName; ArgLen; ArgValue}; |
| 1字节   | 1字节   |  1字节 | 变长 NUM 字节 |

| 消息字 | 参数类型 | 参数个数 | 参数   |
| ----- | ------- | ----- | ------- |
| GET    | TYPE     | NUM  | for (i==0;i<NUM;i++) {ArgName; ArgValue}; |
| 1字节   | 1字节   |  1字节 | 变长 NUM 字节 |

| 消息字 | 参数类型 | 参数个数 | 参数   |
| ----- | ------- | ----- | ------- |
| SET/RPT  | TYPE     | NUM  | for (i==0;i<NUM;i++) {ArgName; ArgLen; ArgValue}; |
| 1字节   | 1字节   |  1字节 | 变长 NUM 字节 |

说明：
1. 当消息字是GET时，参数没有长度，当消息字时SET时，参数带长度。

### 消息字

| 类型名   | 类型  | 值   |
| -------- | ----- | ---- |
| 查询 GET | 1字节 | 0x1  |
| 设置 SET | 1字节 | 0x2  |
| 上报 RPT | 1字节 | 0x3  |
| ACK      | 1字节 | 0x4  |

#### 参数类型

 TYPE（参数类型）包括：

| 参数类型                               | 类型 |
| -------------------------------------- | ---- |
| 灯控器/调光面版                        | 0x01 |
| 人体移动感应器                         | 0x02 |
| 光照度传感器                           | 0x03 |
| 门磁（窗磁）传感器                     | 0x04 |
| 温湿度传感器                           | 0x05 |
| 环境盒子（空气盒子或者环境检测）传感器 | 0x06 |
| 一键开关（报警）                       | 0x07 |
| 水浸传感器                             | 0x08 |
| 声光报警器                             | 0x09 |
| 烟雾报警器                             | 0x0A |
| 燃气泄漏传感器                         | 0x0B |
| 开关面板                               | 0x0C |
| 情景面板                               | 0x0D |
| 温控、新风、地暖面板                   | 0x0E |
| 调光面板、窗帘面板                     | 0x0F |
| 普通智能插座                           | 0x10 |
| 智能计量插座                           | 0x11 |
| 窗帘电机                               | 0x12 |
| 机械臂、推窗器                         | 0x13 |
| 红外转发器                             | 0x14 |
| 智能门锁                               | 0x15 |
| 透传设备                               | 0x16 |
| ...                                    | 0xFE |
| 公共类型                               | 0xFF |

说明：

FF表示公共参数，所有设备均有公共参数，公共参数包括：设备厂家名，自定义描述，软版本号，设备类型，维测参数（ToDo）。

#### 参数类型

##### 公共类型

| 参数    | 类型 | 功能         |
| ------- | ---- | ------------ |
| FAC     | 0x1  | 厂家名       |
| DSP     | 0x2  | 自定义描述   |
| SWV     | 0x3  | 软版本号     |
| TYPE    | 0x4  | 设备类型     |
| PING    | 0x5  | 心跳         |
| RFPWR   | 0x6  | 发射功率     |
| RSRP    | 0x7  | 接收信号强度 |
| SNR     | 0x8  | 信噪比       |
| CHANNEL | 0x9  | 信道选择     |

说明：

公共参数的数据格式根据消息字不同而不同，如果消息字是GET，则每个参数不带长度字段。如果消息字是SET或者RPT，则每个参数需要带长度字段，详见下表。

###### 查询 GET

| 参数 | 类型 |
| ---- | ---- |
| FAC  | 0x1  |
| DSP  | 0x2  |
| SWV  | 0x3  |
| TYPE | 0x4  |
| PING   | 0x5  |
| RFPWR  | 0x6  |
| RSRP   | 0x7  |
| SNR    | 0x8  |
| CHANNEL| 0x9 |

###### 设置SET/上报 RPT

| 参数 | 值   | 参数值长度 | 参数值类型 |
| ---- | ---- | ----- | ------ |
| FAC  | 0x1  | 1～32 | string |
| DSP  | 0x2  | 1～32 | string |
| SWV  | 0x3  | 1～32 | string |
| TYPE | 0x4  | 1     | byte   |
| PING   | 0x5  | 3 | byte |
| RFPWR  | 0x6  | 1 | byte |
| RSRP   | 0x7  | 1 | byte |
| SNR    | 0x8  | 1 | byte |
| CHANNEL| 0x9 |  1 | byte |
###### 举例

设置并查询 FAC 和 SWV

1. 0x02 0xFF 0x02 0x01 0x0D ASCII('FatoryName') 0x03 0x04 ASCII('2019')
2. 0x04
3. 0x01 0xFF 0x02 0x01 0x03
4. 0x03 0xFF 0x02 0x01 0x0D ASCII('FatoryName') 0x03 0x04 ASCII('2019')

含义如下图：

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuGfEBIfBBLBGjLFmoqz9LR1I27ODKJ2eS7DJC59mStHMC3HKK79BJ2x9BwhqIynDLL883WzJC55GCZ8mj5JY0ki1weMQOgNWwEoDQQGxgf504p0r1WMGOAr3QbuAqF40)  

设置并查询 TYPE

1. 0x02 0xFF 0x01 0x04 0x01 0x10
2. 0x04
3. 0x01 0xFF 0x01 0x04
4. 0x03 0xFF 0x01 0x04 0x01 0x10

含义如下图：

![](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuGfEBIfBBLBGjLFmoqz9LR1I27ODKJ2eS7DJC5G8YGnm1L865OO6N61Pe2geUYi5HsTlJCtkg9enTGK5O3NT8JKl1UWQ0000)

##### 其他设备类型

 (TODO)参考[产品列表](https://github.com/zrainx/IOT/blob/master/%E4%BA%A7%E5%93%81%E5%88%97%E8%A1%A8.docx)




